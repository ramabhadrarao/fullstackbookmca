<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB Aggregations - Complete Tutorial</title>
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .content-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .section-title {
            color: #206bc4;
            border-bottom: 3px solid #206bc4;
            padding-bottom: 0.5rem;
            margin-top: 2rem;
            margin-bottom: 1.5rem;
        }
        .code-block {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
        }
        .example-card {
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .output-section {
            background: #f0f9ff;
            border-left: 4px solid #0184ff;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        .note-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        .tip-box {
            background: #d1f2eb;
            border-left: 4px solid #28a745;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        pre {
            margin: 0;
        }
        .table-responsive {
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="page-wrapper">
            <!-- Header -->
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h1 class="page-title">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-database" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                    <ellipse cx="12" cy="6" rx="8" ry="3"></ellipse>
                                    <path d="M4 6v6a8 3 0 0 0 16 0v-6"></path>
                                    <path d="M4 12v6a8 3 0 0 0 16 0v-6"></path>
                                </svg>
                                MongoDB Aggregations - Complete Tutorial
                            </h1>
                            <div class="text-muted mt-2">
                                Master MongoDB aggregation framework with practical examples
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="page-body">
                <div class="container-xl">
                    
                    <!-- Introduction -->
                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">üìö Introduction to MongoDB Aggregations</h3>
                        </div>
                        <div class="card-body">
                            <p>The MongoDB Aggregation Framework is a powerful tool for data processing and transformation. It allows you to:</p>
                            <ul>
                                <li>Filter, sort, and group documents</li>
                                <li>Perform complex calculations and transformations</li>
                                <li>Join data from multiple collections</li>
                                <li>Reshape documents and create computed fields</li>
                            </ul>
                            <div class="note-box">
                                <strong>üìù Note:</strong> Aggregation pipelines process documents through multiple stages, where each stage transforms the documents and passes them to the next stage.
                            </div>
                        </div>
                    </div>

                    <!-- Database Setup -->
                    <h2 class="section-title">1. Database Setup & Sample Data</h2>
                    
                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">Creating the Database and Collections</h3>
                        </div>
                        <div class="card-body">
                            <p>First, let's create a database and insert sample data for our examples.</p>
                            
                            <div class="code-block">
<pre><code class="language-javascript">// Switch to database
use salesDB

// Clear existing data (if any)
db.products.drop()
db.orders.drop()
db.customers.drop()
</code></pre>
                            </div>

                            <h4 class="mt-4">Products Collection</h4>
                            <div class="code-block">
<pre><code class="language-javascript">// Insert Products
db.products.insertMany([
    {
        _id: 1,
        name: "Laptop",
        category: "Electronics",
        price: 999.99,
        stock: 50,
        brand: "TechBrand",
        ratings: [5, 4, 5, 4, 5]
    },
    {
        _id: 2,
        name: "Smartphone",
        category: "Electronics",
        price: 699.99,
        stock: 100,
        brand: "PhoneCorp",
        ratings: [4, 4, 5, 3, 4]
    },
    {
        _id: 3,
        name: "Desk Chair",
        category: "Furniture",
        price: 199.99,
        stock: 30,
        brand: "ComfortSeats",
        ratings: [5, 5, 4, 5]
    },
    {
        _id: 4,
        name: "Monitor",
        category: "Electronics",
        price: 299.99,
        stock: 75,
        brand: "TechBrand",
        ratings: [4, 5, 4, 4, 5]
    },
    {
        _id: 5,
        name: "Desk Lamp",
        category: "Furniture",
        price: 49.99,
        stock: 150,
        brand: "BrightLight",
        ratings: [4, 4, 3, 4]
    }
])
</code></pre>
                            </div>

                            <h4 class="mt-4">Customers Collection</h4>
                            <div class="code-block">
<pre><code class="language-javascript">// Insert Customers
db.customers.insertMany([
    {
        _id: 101,
        name: "John Smith",
        email: "john@example.com",
        city: "New York",
        age: 35,
        memberSince: new Date("2022-01-15")
    },
    {
        _id: 102,
        name: "Sarah Johnson",
        email: "sarah@example.com",
        city: "Los Angeles",
        age: 28,
        memberSince: new Date("2022-03-20")
    },
    {
        _id: 103,
        name: "Michael Brown",
        email: "michael@example.com",
        city: "Chicago",
        age: 42,
        memberSince: new Date("2021-11-10")
    },
    {
        _id: 104,
        name: "Emily Davis",
        email: "emily@example.com",
        city: "New York",
        age: 31,
        memberSince: new Date("2022-05-08")
    },
    {
        _id: 105,
        name: "David Wilson",
        email: "david@example.com",
        city: "Los Angeles",
        age: 39,
        memberSince: new Date("2021-09-25")
    }
])
</code></pre>
                            </div>

                            <h4 class="mt-4">Orders Collection</h4>
                            <div class="code-block">
<pre><code class="language-javascript">// Insert Orders
db.orders.insertMany([
    {
        _id: 1001,
        customerId: 101,
        orderDate: new Date("2024-01-15"),
        status: "delivered",
        items: [
            { productId: 1, quantity: 1, price: 999.99 },
            { productId: 4, quantity: 2, price: 299.99 }
        ],
        totalAmount: 1599.97
    },
    {
        _id: 1002,
        customerId: 102,
        orderDate: new Date("2024-01-20"),
        status: "delivered",
        items: [
            { productId: 2, quantity: 1, price: 699.99 }
        ],
        totalAmount: 699.99
    },
    {
        _id: 1003,
        customerId: 103,
        orderDate: new Date("2024-02-05"),
        status: "processing",
        items: [
            { productId: 3, quantity: 2, price: 199.99 },
            { productId: 5, quantity: 3, price: 49.99 }
        ],
        totalAmount: 549.95
    },
    {
        _id: 1004,
        customerId: 101,
        orderDate: new Date("2024-02-10"),
        status: "delivered",
        items: [
            { productId: 5, quantity: 1, price: 49.99 }
        ],
        totalAmount: 49.99
    },
    {
        _id: 1005,
        customerId: 104,
        orderDate: new Date("2024-02-15"),
        status: "shipped",
        items: [
            { productId: 1, quantity: 1, price: 999.99 },
            { productId: 2, quantity: 1, price: 699.99 }
        ],
        totalAmount: 1699.98
    },
    {
        _id: 1006,
        customerId: 105,
        orderDate: new Date("2024-03-01"),
        status: "delivered",
        items: [
            { productId: 4, quantity: 1, price: 299.99 }
        ],
        totalAmount: 299.99
    }
])
</code></pre>
                            </div>

                            <div class="output-section mt-4">
                                <strong>‚úÖ Expected Output:</strong>
                                <pre><code>{ acknowledged: true, insertedIds: { '0': 1, '1': 2, '2': 3, '3': 4, '4': 5 } }
{ acknowledged: true, insertedIds: { '0': 101, '1': 102, '2': 103, '3': 104, '4': 105 } }
{ acknowledged: true, insertedIds: { '0': 1001, '1': 1002, '2': 1003, '3': 1004, '4': 1005, '5': 1006 } }</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Basic Aggregation Stages -->
                    <h2 class="section-title">2. Basic Aggregation Stages</h2>

                    <!-- $match Stage -->
                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">$match - Filter Documents</h3>
                        </div>
                        <div class="card-body">
                            <p>The <code>$match</code> stage filters documents, similar to the <code>find()</code> method.</p>
                            
                            <h5>Example 1: Find Electronics Products</h5>
                            <div class="code-block">
<pre><code class="language-javascript">db.products.aggregate([
    {
        $match: {
            category: "Electronics"
        }
    }
])
</code></pre>
                            </div>

                            <div class="output-section">
                                <strong>Output:</strong>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped">
                                        <thead>
                                            <tr>
                                                <th>_id</th>
                                                <th>Name</th>
                                                <th>Category</th>
                                                <th>Price</th>
                                                <th>Stock</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr><td>1</td><td>Laptop</td><td>Electronics</td><td>$999.99</td><td>50</td></tr>
                                            <tr><td>2</td><td>Smartphone</td><td>Electronics</td><td>$699.99</td><td>100</td></tr>
                                            <tr><td>4</td><td>Monitor</td><td>Electronics</td><td>$299.99</td><td>75</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <h5 class="mt-4">Example 2: Find Products with Price Greater Than $500</h5>
                            <div class="code-block">
<pre><code class="language-javascript">db.products.aggregate([
    {
        $match: {
            price: { $gt: 500 }
        }
    }
])
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- $project Stage -->
                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">$project - Shape Documents</h3>
                        </div>
                        <div class="card-body">
                            <p>The <code>$project</code> stage reshapes documents by including, excluding, or adding computed fields.</p>
                            
                            <h5>Example 1: Select Specific Fields</h5>
                            <div class="code-block">
<pre><code class="language-javascript">db.products.aggregate([
    {
        $project: {
            name: 1,
            price: 1,
            category: 1,
            _id: 0  // Exclude _id
        }
    }
])
</code></pre>
                            </div>

                            <h5 class="mt-4">Example 2: Create Computed Fields</h5>
                            <div class="code-block">
<pre><code class="language-javascript">db.products.aggregate([
    {
        $project: {
            name: 1,
            price: 1,
            // Calculate discount price (20% off)
            discountPrice: { $multiply: ["$price", 0.8] },
            // Calculate total value in stock
            stockValue: { $multiply: ["$price", "$stock"] },
            // Check if expensive (price > 500)
            isExpensive: { $gt: ["$price", 500] }
        }
    }
])
</code></pre>
                            </div>

                            <div class="output-section">
                                <strong>Sample Output:</strong>
                                <pre><code>{
  "_id": 1,
  "name": "Laptop",
  "price": 999.99,
  "discountPrice": 799.992,
  "stockValue": 49999.5,
  "isExpensive": true
}</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- $group Stage -->
                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">$group - Group and Aggregate</h3>
                        </div>
                        <div class="card-body">
                            <p>The <code>$group</code> stage groups documents by a specified expression and performs aggregations.</p>
                            
                            <h5>Example 1: Count Products by Category</h5>
                            <div class="code-block">
<pre><code class="language-javascript">db.products.aggregate([
    {
        $group: {
            _id: "$category",
            count: { $sum: 1 },
            totalStock: { $sum: "$stock" },
            avgPrice: { $avg: "$price" }
        }
    }
])
</code></pre>
                            </div>

                            <div class="output-section">
                                <strong>Output:</strong>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped">
                                        <thead>
                                            <tr>
                                                <th>Category</th>
                                                <th>Count</th>
                                                <th>Total Stock</th>
                                                <th>Avg Price</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr><td>Electronics</td><td>3</td><td>225</td><td>$666.66</td></tr>
                                            <tr><td>Furniture</td><td>2</td><td>180</td><td>$124.99</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <h5 class="mt-4">Example 2: Total Sales by Customer</h5>
                            <div class="code-block">
<pre><code class="language-javascript">db.orders.aggregate([
    {
        $group: {
            _id: "$customerId",
            totalOrders: { $sum: 1 },
            totalSpent: { $sum: "$totalAmount" },
            avgOrderValue: { $avg: "$totalAmount" }
        }
    },
    {
        $sort: { totalSpent: -1 }  // Sort by total spent (descending)
    }
])
</code></pre>
                            </div>

                            <div class="output-section">
                                <strong>Output:</strong>
                                <pre><code>[
  { "_id": 104, "totalOrders": 1, "totalSpent": 1699.98, "avgOrderValue": 1699.98 },
  { "_id": 101, "totalOrders": 2, "totalSpent": 1649.96, "avgOrderValue": 824.98 },
  { "_id": 102, "totalOrders": 1, "totalSpent": 699.99, "avgOrderValue": 699.99 },
  { "_id": 103, "totalOrders": 1, "totalSpent": 549.95, "avgOrderValue": 549.95 },
  { "_id": 105, "totalOrders": 1, "totalSpent": 299.99, "avgOrderValue": 299.99 }
]</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- $sort Stage -->
                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">$sort - Sort Documents</h3>
                        </div>
                        <div class="card-body">
                            <p>The <code>$sort</code> stage sorts documents by specified fields (1 for ascending, -1 for descending).</p>
                            
                            <div class="code-block">
<pre><code class="language-javascript">db.products.aggregate([
    {
        $sort: {
            price: -1  // Sort by price descending
        }
    },
    {
        $project: {
            name: 1,
            price: 1,
            category: 1
        }
    }
])
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- $limit and $skip -->
                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">$limit and $skip - Pagination</h3>
                        </div>
                        <div class="card-body">
                            <p>Use <code>$limit</code> and <code>$skip</code> for pagination.</p>
                            
                            <h5>Example: Get Top 3 Most Expensive Products</h5>
                            <div class="code-block">
<pre><code class="language-javascript">db.products.aggregate([
    {
        $sort: { price: -1 }
    },
    {
        $limit: 3
    },
    {
        $project: {
            name: 1,
            price: 1
        }
    }
])
</code></pre>
                            </div>

                            <h5 class="mt-4">Example: Pagination (Skip First 2, Limit to 2)</h5>
                            <div class="code-block">
<pre><code class="language-javascript">db.products.aggregate([
    {
        $sort: { price: -1 }
    },
    {
        $skip: 2  // Skip first 2 results
    },
    {
        $limit: 2  // Return next 2
    }
])
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Aggregations -->
                    <h2 class="section-title">3. Advanced Aggregation Operations</h2>

                    <!-- $lookup Stage -->
                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">$lookup - Join Collections</h3>
                        </div>
                        <div class="card-body">
                            <p>The <code>$lookup</code> stage performs a left outer join with another collection.</p>
                            
                            <h5>Example: Join Orders with Customer Information</h5>
                            <div class="code-block">
<pre><code class="language-javascript">db.orders.aggregate([
    {
        $lookup: {
            from: "customers",           // Collection to join
            localField: "customerId",    // Field from orders collection
            foreignField: "_id",         // Field from customers collection
            as: "customerInfo"           // Output array field
        }
    },
    {
        $project: {
            _id: 1,
            orderDate: 1,
            totalAmount: 1,
            "customerInfo.name": 1,
            "customerInfo.email": 1,
            "customerInfo.city": 1
        }
    }
])
</code></pre>
                            </div>

                            <div class="output-section">
                                <strong>Sample Output:</strong>
                                <pre><code>{
  "_id": 1001,
  "orderDate": ISODate("2024-01-15T00:00:00.000Z"),
  "totalAmount": 1599.97,
  "customerInfo": [
    {
      "name": "John Smith",
      "email": "john@example.com",
      "city": "New York"
    }
  ]
}</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- $unwind Stage -->
                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">$unwind - Deconstruct Arrays</h3>
                        </div>
                        <div class="card-body">
                            <p>The <code>$unwind</code> stage deconstructs an array field to output a document for each element.</p>
                            
                            <h5>Example: Unwind Order Items</h5>
                            <div class="code-block">
<pre><code class="language-javascript">db.orders.aggregate([
    {
        $unwind: "$items"  // Deconstruct items array
    },
    {
        $project: {
            orderId: "$_id",
            customerId: 1,
            productId: "$items.productId",
            quantity: "$items.quantity",
            price: "$items.price",
            itemTotal: { 
                $multiply: ["$items.quantity", "$items.price"] 
            }
        }
    }
])
</code></pre>
                            </div>

                            <div class="output-section">
                                <strong>Sample Output:</strong>
                                <pre><code>{
  "_id": 1001,
  "customerId": 101,
  "orderId": 1001,
  "productId": 1,
  "quantity": 1,
  "price": 999.99,
  "itemTotal": 999.99
}
{
  "_id": 1001,
  "customerId": 101,
  "orderId": 1001,
  "productId": 4,
  "quantity": 2,
  "price": 299.99,
  "itemTotal": 599.98
}</code></pre>
                            </div>

                            <h5 class="mt-4">Example: Most Sold Products</h5>
                            <div class="code-block">
<pre><code class="language-javascript">db.orders.aggregate([
    {
        $unwind: "$items"
    },
    {
        $group: {
            _id: "$items.productId",
            totalQuantitySold: { $sum: "$items.quantity" },
            totalRevenue: { 
                $sum: { 
                    $multiply: ["$items.quantity", "$items.price"] 
                } 
            },
            numberOfOrders: { $sum: 1 }
        }
    },
    {
        $sort: { totalQuantitySold: -1 }
    },
    {
        $lookup: {
            from: "products",
            localField: "_id",
            foreignField: "_id",
            as: "productDetails"
        }
    },
    {
        $unwind: "$productDetails"
    },
    {
        $project: {
            productName: "$productDetails.name",
            totalQuantitySold: 1,
            totalRevenue: 1,
            numberOfOrders: 1,
            avgQuantityPerOrder: { 
                $divide: ["$totalQuantitySold", "$numberOfOrders"] 
            }
        }
    }
])
</code></pre>
                            </div>

                            <div class="output-section">
                                <strong>Output:</strong>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped">
                                        <thead>
                                            <tr>
                                                <th>Product Name</th>
                                                <th>Total Qty Sold</th>
                                                <th>Total Revenue</th>
                                                <th>Orders</th>
                                                <th>Avg Qty/Order</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr><td>Desk Lamp</td><td>4</td><td>$199.96</td><td>2</td><td>2</td></tr>
                                            <tr><td>Monitor</td><td>3</td><td>$899.97</td><td>2</td><td>1.5</td></tr>
                                            <tr><td>Desk Chair</td><td>2</td><td>$399.98</td><td>1</td><td>2</td></tr>
                                            <tr><td>Laptop</td><td>2</td><td>$1999.98</td><td>2</td><td>1</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- $addFields Stage -->
                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">$addFields - Add New Fields</h3>
                        </div>
                        <div class="card-body">
                            <p>The <code>$addFields</code> stage adds new fields to documents.</p>
                            
                            <div class="code-block">
<pre><code class="language-javascript">db.products.aggregate([
    {
        $addFields: {
            // Calculate average rating
            avgRating: { $avg: "$ratings" },
            // Add discount percentage
            discountPercent: 20,
            // Calculate final price
            finalPrice: { 
                $multiply: ["$price", 0.8] 
            },
            // Check stock status
            stockStatus: {
                $switch: {
                    branches: [
                        { case: { $gte: ["$stock", 100] }, then: "High Stock" },
                        { case: { $gte: ["$stock", 50] }, then: "Medium Stock" },
                        { case: { $gt: ["$stock", 0] }, then: "Low Stock" }
                    ],
                    default: "Out of Stock"
                }
            }
        }
    },
    {
        $project: {
            name: 1,
            price: 1,
            stock: 1,
            avgRating: 1,
            finalPrice: 1,
            stockStatus: 1
        }
    }
])
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- $bucket Stage -->
                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">$bucket - Categorize Documents</h3>
                        </div>
                        <div class="card-body">
                            <p>The <code>$bucket</code> stage categorizes documents into buckets based on a specified expression.</p>
                            
                            <h5>Example: Group Products by Price Range</h5>
                            <div class="code-block">
<pre><code class="language-javascript">db.products.aggregate([
    {
        $bucket: {
            groupBy: "$price",
            boundaries: [0, 100, 500, 1000, 2000],
            default: "Other",
            output: {
                count: { $sum: 1 },
                products: { $push: "$name" },
                avgPrice: { $avg: "$price" }
            }
        }
    }
])
</code></pre>
                            </div>

                            <div class="output-section">
                                <strong>Output:</strong>
                                <pre><code>[
  {
    "_id": 0,
    "count": 1,
    "products": ["Desk Lamp"],
    "avgPrice": 49.99
  },
  {
    "_id": 100,
    "count": 2,
    "products": ["Desk Chair", "Monitor"],
    "avgPrice": 249.99
  },
  {
    "_id": 500,
    "count": 2,
    "products": ["Smartphone", "Laptop"],
    "avgPrice": 849.99
  }
]</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- $facet Stage -->
                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">$facet - Multiple Pipelines</h3>
                        </div>
                        <div class="card-body">
                            <p>The <code>$facet</code> stage processes multiple aggregation pipelines within a single stage.</p>
                            
                            <div class="code-block">
<pre><code class="language-javascript">db.products.aggregate([
    {
        $facet: {
            // Pipeline 1: Category statistics
            "categoryStats": [
                {
                    $group: {
                        _id: "$category",
                        count: { $sum: 1 },
                        avgPrice: { $avg: "$price" }
                    }
                }
            ],
            // Pipeline 2: Price ranges
            "priceRanges": [
                {
                    $bucket: {
                        groupBy: "$price",
                        boundaries: [0, 200, 500, 1000],
                        default: "Expensive",
                        output: {
                            count: { $sum: 1 }
                        }
                    }
                }
            ],
            // Pipeline 3: Top 3 expensive products
            "topExpensive": [
                { $sort: { price: -1 } },
                { $limit: 3 },
                { $project: { name: 1, price: 1 } }
            ]
        }
    }
])
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Real-World Examples -->
                    <h2 class="section-title">4. Real-World Complex Examples</h2>

                    <!-- Example 1: Sales Report -->
                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">üìä Complete Sales Report</h3>
                        </div>
                        <div class="card-body">
                            <p>Generate a comprehensive sales report with customer information and order details.</p>
                            
                            <div class="code-block">
<pre><code class="language-javascript">db.orders.aggregate([
    // Stage 1: Lookup customer information
    {
        $lookup: {
            from: "customers",
            localField: "customerId",
            foreignField: "_id",
            as: "customer"
        }
    },
    // Stage 2: Unwind customer array
    {
        $unwind: "$customer"
    },
    // Stage 3: Add month and year fields
    {
        $addFields: {
            month: { $month: "$orderDate" },
            year: { $year: "$orderDate" },
            customerName: "$customer.name",
            customerCity: "$customer.city"
        }
    },
    // Stage 4: Group by month and calculate totals
    {
        $group: {
            _id: {
                year: "$year",
                month: "$month"
            },
            totalOrders: { $sum: 1 },
            totalRevenue: { $sum: "$totalAmount" },
            avgOrderValue: { $avg: "$totalAmount" },
            uniqueCustomers: { $addToSet: "$customerId" },
            orders: {
                $push: {
                    orderId: "$_id",
                    customer: "$customerName",
                    city: "$customerCity",
                    amount: "$totalAmount",
                    status: "$status"
                }
            }
        }
    },
    // Stage 5: Add computed fields
    {
        $addFields: {
            uniqueCustomerCount: { $size: "$uniqueCustomers" }
        }
    },
    // Stage 6: Sort by date
    {
        $sort: {
            "_id.year": 1,
            "_id.month": 1
        }
    },
    // Stage 7: Format output
    {
        $project: {
            _id: 0,
            period: {
                $concat: [
                    { $toString: "$_id.year" },
                    "-",
                    { 
                        $cond: [
                            { $lt: ["$_id.month", 10] },
                            { $concat: ["0", { $toString: "$_id.month" }] },
                            { $toString: "$_id.month" }
                        ]
                    }
                ]
            },
            totalOrders: 1,
            totalRevenue: { $round: ["$totalRevenue", 2] },
            avgOrderValue: { $round: ["$avgOrderValue", 2] },
            uniqueCustomers: "$uniqueCustomerCount",
            orders: 1
        }
    }
])
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Example 2: Customer Lifetime Value -->
                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">üí∞ Customer Lifetime Value Analysis</h3>
                        </div>
                        <div class="card-body">
                            <div class="code-block">
<pre><code class="language-javascript">db.orders.aggregate([
    // Stage 1: Unwind items to analyze product-level data
    {
        $unwind: "$items"
    },
    // Stage 2: Group by customer
    {
        $group: {
            _id: "$customerId",
            totalOrders: { $sum: 1 },
            totalSpent: { 
                $sum: { 
                    $multiply: ["$items.quantity", "$items.price"] 
                } 
            },
            avgOrderValue: { 
                $avg: { 
                    $multiply: ["$items.quantity", "$items.price"] 
                } 
            },
            firstOrderDate: { $min: "$orderDate" },
            lastOrderDate: { $max: "$orderDate" },
            productsOrdered: { $addToSet: "$items.productId" }
        }
    },
    // Stage 3: Lookup customer details
    {
        $lookup: {
            from: "customers",
            localField: "_id",
            foreignField: "_id",
            as: "customerInfo"
        }
    },
    // Stage 4: Unwind customer info
    {
        $unwind: "$customerInfo"
    },
    // Stage 5: Calculate additional metrics
    {
        $addFields: {
            customerName: "$customerInfo.name",
            customerEmail: "$customerInfo.email",
            customerCity: "$customerInfo.city",
            productDiversity: { $size: "$productsOrdered" },
            customerTenure: {
                $divide: [
                    { $subtract: ["$lastOrderDate", "$firstOrderDate"] },
                    1000 * 60 * 60 * 24  // Convert to days
                ]
            }
        }
    },
    // Stage 6: Categorize customers
    {
        $addFields: {
            customerSegment: {
                $switch: {
                    branches: [
                        { 
                            case: { $gte: ["$totalSpent", 1500] }, 
                            then: "VIP" 
                        },
                        { 
                            case: { $gte: ["$totalSpent", 500] }, 
                            then: "Regular" 
                        }
                    ],
                    default: "New"
                }
            }
        }
    },
    // Stage 7: Sort by total spent
    {
        $sort: { totalSpent: -1 }
    },
    // Stage 8: Project final output
    {
        $project: {
            _id: 0,
            customerId: "$_id",
            customerName: 1,
            customerEmail: 1,
            customerCity: 1,
            totalOrders: 1,
            totalSpent: { $round: ["$totalSpent", 2] },
            avgOrderValue: { $round: ["$avgOrderValue", 2] },
            productDiversity: 1,
            customerSegment: 1,
            customerTenure: { $round: ["$customerTenure", 0] },
            firstOrderDate: 1,
            lastOrderDate: 1
        }
    }
])
</code></pre>
                            </div>

                            <div class="tip-box">
                                <strong>üí° Use Case:</strong> This pipeline helps identify your most valuable customers, track customer engagement, and segment customers for targeted marketing campaigns.
                            </div>
                        </div>
                    </div>

                    <!-- Example 3: Product Performance -->
                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">üìà Product Performance Dashboard</h3>
                        </div>
                        <div class="card-body">
                            <div class="code-block">
<pre><code class="language-javascript">db.products.aggregate([
    // Stage 1: Calculate average rating
    {
        $addFields: {
            avgRating: { $avg: "$ratings" },
            ratingCount: { $size: "$ratings" }
        }
    },
    // Stage 2: Lookup order items for this product
    {
        $lookup: {
            from: "orders",
            let: { productId: "$_id" },
            pipeline: [
                { $unwind: "$items" },
                { 
                    $match: { 
                        $expr: { $eq: ["$items.productId", "$$productId"] } 
                    } 
                },
                {
                    $group: {
                        _id: null,
                        totalSold: { $sum: "$items.quantity" },
                        totalRevenue: { 
                            $sum: { 
                                $multiply: ["$items.quantity", "$items.price"] 
                            } 
                        },
                        orderCount: { $sum: 1 }
                    }
                }
            ],
            as: "salesData"
        }
    },
    // Stage 3: Add sales information
    {
        $addFields: {
            totalSold: { 
                $ifNull: [
                    { $arrayElemAt: ["$salesData.totalSold", 0] }, 
                    0
                ] 
            },
            totalRevenue: { 
                $ifNull: [
                    { $arrayElemAt: ["$salesData.totalRevenue", 0] }, 
                    0
                ] 
            },
            orderCount: { 
                $ifNull: [
                    { $arrayElemAt: ["$salesData.orderCount", 0] }, 
                    0
                ] 
            }
        }
    },
    // Stage 4: Calculate metrics
    {
        $addFields: {
            stockTurnoverRate: {
                $cond: [
                    { $gt: ["$stock", 0] },
                    { 
                        $multiply: [
                            { $divide: ["$totalSold", "$stock"] },
                            100
                        ]
                    },
                    0
                ]
            },
            revenuePerUnit: {
                $cond: [
                    { $gt: ["$totalSold", 0] },
                    { $divide: ["$totalRevenue", "$totalSold"] },
                    0
                ]
            }
        }
    },
    // Stage 5: Determine performance status
    {
        $addFields: {
            performanceStatus: {
                $switch: {
                    branches: [
                        {
                            case: { 
                                $and: [
                                    { $gte: ["$avgRating", 4.5] },
                                    { $gte: ["$totalSold", 3] }
                                ]
                            },
                            then: "Best Seller"
                        },
                        {
                            case: { 
                                $and: [
                                    { $gte: ["$avgRating", 4] },
                                    { $gte: ["$totalSold", 2] }
                                ]
                            },
                            then: "Good Performance"
                        },
                        {
                            case: { $lte: ["$totalSold", 1] },
                            then: "Slow Moving"
                        }
                    ],
                    default: "Average"
                }
            }
        }
    },
    // Stage 6: Sort by revenue
    {
        $sort: { totalRevenue: -1 }
    },
    // Stage 7: Project final output
    {
        $project: {
            _id: 1,
            name: 1,
            category: 1,
            brand: 1,
            price: 1,
            stock: 1,
            avgRating: { $round: ["$avgRating", 2] },
            ratingCount: 1,
            totalSold: 1,
            totalRevenue: { $round: ["$totalRevenue", 2] },
            orderCount: 1,
            stockTurnoverRate: { $round: ["$stockTurnoverRate", 2] },
            revenuePerUnit: { $round: ["$revenuePerUnit", 2] },
            performanceStatus: 1
        }
    }
])
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Aggregation Operators -->
                    <h2 class="section-title">5. Common Aggregation Operators</h2>

                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">Arithmetic Operators</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Operator</th>
                                            <th>Description</th>
                                            <th>Example</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><code>$add</code></td>
                                            <td>Adds numbers</td>
                                            <td><code>{ $add: ["$price", 10] }</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>$subtract</code></td>
                                            <td>Subtracts numbers</td>
                                            <td><code>{ $subtract: ["$price", "$discount"] }</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>$multiply</code></td>
                                            <td>Multiplies numbers</td>
                                            <td><code>{ $multiply: ["$price", "$quantity"] }</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>$divide</code></td>
                                            <td>Divides numbers</td>
                                            <td><code>{ $divide: ["$total", "$count"] }</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>$mod</code></td>
                                            <td>Modulo operation</td>
                                            <td><code>{ $mod: ["$number", 10] }</code></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">Comparison Operators</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Operator</th>
                                            <th>Description</th>
                                            <th>Example</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><code>$eq</code></td>
                                            <td>Equal to</td>
                                            <td><code>{ $eq: ["$status", "active"] }</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>$ne</code></td>
                                            <td>Not equal to</td>
                                            <td><code>{ $ne: ["$status", "deleted"] }</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>$gt</code></td>
                                            <td>Greater than</td>
                                            <td><code>{ $gt: ["$price", 100] }</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>$gte</code></td>
                                            <td>Greater than or equal</td>
                                            <td><code>{ $gte: ["$score", 50] }</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>$lt</code></td>
                                            <td>Less than</td>
                                            <td><code>{ $lt: ["$age", 18] }</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>$lte</code></td>
                                            <td>Less than or equal</td>
                                            <td><code>{ $lte: ["$discount", 20] }</code></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">Array Operators</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Operator</th>
                                            <th>Description</th>
                                            <th>Example</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><code>$push</code></td>
                                            <td>Adds element to array</td>
                                            <td><code>{ $push: "$name" }</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>$addToSet</code></td>
                                            <td>Adds unique element</td>
                                            <td><code>{ $addToSet: "$category" }</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>$size</code></td>
                                            <td>Returns array length</td>
                                            <td><code>{ $size: "$items" }</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>$arrayElemAt</code></td>
                                            <td>Returns element at index</td>
                                            <td><code>{ $arrayElemAt: ["$items", 0] }</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>$filter</code></td>
                                            <td>Filters array elements</td>
                                            <td><code>{ $filter: { input: "$items", cond: {...} } }</code></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">Accumulator Operators (in $group)</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Operator</th>
                                            <th>Description</th>
                                            <th>Example</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><code>$sum</code></td>
                                            <td>Sum of values</td>
                                            <td><code>{ $sum: "$amount" }</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>$avg</code></td>
                                            <td>Average of values</td>
                                            <td><code>{ $avg: "$price" }</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>$min</code></td>
                                            <td>Minimum value</td>
                                            <td><code>{ $min: "$price" }</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>$max</code></td>
                                            <td>Maximum value</td>
                                            <td><code>{ $max: "$score" }</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>$first</code></td>
                                            <td>First value in group</td>
                                            <td><code>{ $first: "$name" }</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>$last</code></td>
                                            <td>Last value in group</td>
                                            <td><code>{ $last: "$status" }</code></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Best Practices -->
                    <h2 class="section-title">6. Best Practices & Tips</h2>

                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">‚ö° Performance Optimization</h3>
                        </div>
                        <div class="card-body">
                            <ol>
                                <li class="mb-2">
                                    <strong>Use $match early:</strong> Place $match stages as early as possible to reduce documents processed.
                                    <div class="code-block mt-2">
<pre><code class="language-javascript">// Good - Filter early
db.products.aggregate([
    { $match: { category: "Electronics" } },  // Reduce dataset first
    { $group: { _id: "$brand", count: { $sum: 1 } } }
])

// Bad - Filter late
db.products.aggregate([
    { $group: { _id: "$brand", count: { $sum: 1 } } },
    { $match: { category: "Electronics" } }  // Too late
])
</code></pre>
                                    </div>
                                </li>
                                
                                <li class="mb-2">
                                    <strong>Use indexes:</strong> Ensure fields used in $match and $sort have indexes.
                                    <div class="code-block mt-2">
<pre><code class="language-javascript">// Create indexes
db.products.createIndex({ category: 1 })
db.products.createIndex({ price: -1 })
db.orders.createIndex({ customerId: 1, orderDate: -1 })
</code></pre>
                                    </div>
                                </li>
                                
                                <li class="mb-2">
                                    <strong>Limit early:</strong> Use $limit after $sort to reduce processing.
                                    <div class="code-block mt-2">
<pre><code class="language-javascript">db.products.aggregate([
    { $sort: { price: -1 } },
    { $limit: 10 }  // Only process top 10
])
</code></pre>
                                    </div>
                                </li>
                                
                                <li class="mb-2">
                                    <strong>Project only needed fields:</strong> Reduce document size early with $project.
                                    <div class="code-block mt-2">
<pre><code class="language-javascript">db.products.aggregate([
    { $match: { category: "Electronics" } },
    { $project: { name: 1, price: 1 } },  // Only keep needed fields
    { $sort: { price: -1 } }
])
</code></pre>
                                    </div>
                                </li>
                                
                                <li class="mb-2">
                                    <strong>Use $lookup wisely:</strong> Join only when necessary and filter before lookup.
                                </li>
                            </ol>
                        </div>
                    </div>

                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">üìã Common Patterns</h3>
                        </div>
                        <div class="card-body">
                            <h5>Pattern 1: Pagination</h5>
                            <div class="code-block">
<pre><code class="language-javascript">// Page 1: skip 0, limit 10
// Page 2: skip 10, limit 10
// Page 3: skip 20, limit 10

const page = 2;
const limit = 10;

db.products.aggregate([
    { $sort: { price: -1 } },
    { $skip: (page - 1) * limit },
    { $limit: limit }
])
</code></pre>
                            </div>

                            <h5 class="mt-4">Pattern 2: Conditional Fields</h5>
                            <div class="code-block">
<pre><code class="language-javascript">db.products.aggregate([
    {
        $project: {
            name: 1,
            price: 1,
            discount: {
                $cond: {
                    if: { $gte: ["$price", 500] },
                    then: { $multiply: ["$price", 0.2] },  // 20% off
                    else: { $multiply: ["$price", 0.1] }   // 10% off
                }
            }
        }
    }
])
</code></pre>
                            </div>

                            <h5 class="mt-4">Pattern 3: Date Grouping</h5>
                            <div class="code-block">
<pre><code class="language-javascript">// Group by year and month
db.orders.aggregate([
    {
        $group: {
            _id: {
                year: { $year: "$orderDate" },
                month: { $month: "$orderDate" }
            },
            totalSales: { $sum: "$totalAmount" },
            orderCount: { $sum: 1 }
        }
    },
    {
        $sort: { "_id.year": 1, "_id.month": 1 }
    }
])
</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Practice Exercises -->
                    <h2 class="section-title">7. Practice Exercises</h2>

                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">üéØ Exercise Challenges</h3>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <strong>Try these yourself!</strong> Use the sample data provided to solve these problems.
                            </div>

                            <h5>Exercise 1: Find Top Customers</h5>
                            <p>Find the top 3 customers by total spending, including their name, email, total spent, and number of orders.</p>

                            <h5 class="mt-4">Exercise 2: Monthly Revenue</h5>
                            <p>Calculate total revenue for each month in 2024.</p>

                            <h5 class="mt-4">Exercise 3: Product Categories</h5>
                            <p>For each category, find the most expensive product, cheapest product, and average price.</p>

                            <h5 class="mt-4">Exercise 4: Customer Orders by City</h5>
                            <p>Group orders by customer city and calculate total orders and revenue per city.</p>

                            <h5 class="mt-4">Exercise 5: Items per Order</h5>
                            <p>Find orders with more than 2 different products and calculate the total items quantity.</p>

                            <div class="tip-box mt-4">
                                <strong>üí° Hint:</strong> Use $lookup to join collections, $unwind for arrays, $group for aggregations, and $sort to order results!
                            </div>
                        </div>
                    </div>

                    <!-- Conclusion -->
                    <div class="card example-card">
                        <div class="card-header">
                            <h3 class="card-title">üéì Conclusion</h3>
                        </div>
                        <div class="card-body">
                            <p>You've learned the MongoDB Aggregation Framework! Key takeaways:</p>
                            <ul>
                                <li>Aggregation pipelines process documents through multiple stages</li>
                                <li>Use $match early to filter and improve performance</li>
                                <li>$group performs calculations and grouping operations</li>
                                <li>$lookup joins data from multiple collections</li>
                                <li>$project and $addFields reshape and add computed fields</li>
                                <li>Combine stages for complex data transformations</li>
                            </ul>

                            <div class="note-box mt-3">
                                <strong>üìö Further Learning:</strong>
                                <ul class="mb-0">
                                    <li>MongoDB Official Documentation: <a href="https://docs.mongodb.com/manual/aggregation/" target="_blank">Aggregation Pipeline</a></li>
                                    <li>Practice with larger datasets</li>
                                    <li>Explore more aggregation operators</li>
                                    <li>Learn about aggregation performance optimization</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Footer -->
            <footer class="footer footer-transparent d-print-none">
                <div class="container-xl">
                    <div class="row text-center align-items-center">
                        <div class="col-12 col-lg-auto mt-3 mt-lg-0">
                            <ul class="list-inline list-inline-dots mb-0">
                                <li class="list-inline-item">
                                    Created for educational purposes
                                </li>
                                <li class="list-inline-item">
                                    MongoDB Aggregations Tutorial ¬© 2024
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/js/tabler.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
</body>
</html>